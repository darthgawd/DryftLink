generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum SiteCheckStatus {
  SUCCESS
  ERROR
  TIMEOUT
  BLOCKED
}

enum UptimeState {
  UP
  DOWN
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sites Site[]
}

model Site {
  id        String   @id @default(cuid())
  name      String
  url       String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // uptime monitoring
  checks       SiteCheck[]
  uptimeState  SiteUptimeState?
  uptimeEvents UptimeEvent[]

  @@unique([userId, url])
  @@index([userId])
}

model SiteCheck {
  id         String         @id @default(cuid())
  siteId     String
  site       Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)

  status     SiteCheckStatus
  httpStatus Int?
  finalUrl   String?
  durationMs Int?
  checkedAt  DateTime       @default(now())

  @@index([siteId, checkedAt])
  @@index([checkedAt])
}

model SiteUptimeState {
  siteId         String         @id
  site           Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)

  state          UptimeState
  lastStatus     SiteCheckStatus
  lastHttpStatus Int?
  lastFinalUrl   String?
  lastDurationMs Int?

  changedAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model UptimeEvent {
  id              String         @id @default(cuid())
  siteId           String
  site             Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)

  fromState        UptimeState
  toState          UptimeState
  reasonStatus     SiteCheckStatus
  reasonHttpStatus Int?
  checkedAt        DateTime
  createdAt        DateTime       @default(now())

  @@index([siteId, createdAt])
  @@index([createdAt])
}
