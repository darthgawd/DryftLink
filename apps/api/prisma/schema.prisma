generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum SiteCheckStatus {
  SUCCESS
  ERROR
  TIMEOUT
  BLOCKED
}

enum UptimeState {
  UP
  DOWN
}

enum ChangeLevel {
  NONE
  MINOR
  MODERATE
  MAJOR
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sites Site[]
}

model Site {
  id        String   @id @default(cuid())
  name      String
  url       String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // scheduling
  checkInterval        Int     @default(5) // minutes
  isMonitoringEnabled  Boolean @default(true)

  // confirmation (anti-flapping)
  confirmationsRequired Int @default(2) // consecutive failures needed before DOWN

  // uptime monitoring
  checks       SiteCheck[]
  uptimeState  SiteUptimeState?
  uptimeEvents UptimeEvent[]

  // change detection
  snapshots    SiteSnapshot[]

  @@unique([userId, url])
  @@index([userId])
}

model SiteCheck {
  id         String         @id @default(cuid())
  siteId     String
  site       Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)

  status     SiteCheckStatus
  httpStatus Int?
  finalUrl   String?
  durationMs Int?
  checkedAt  DateTime       @default(now())

  @@index([siteId, checkedAt])
  @@index([checkedAt])
}

model SiteUptimeState {
  siteId         String         @id
  site           Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)

  state          UptimeState
  lastStatus     SiteCheckStatus
  lastHttpStatus Int?
  lastFinalUrl   String?
  lastDurationMs Int?

  // confirmation tracking
  consecutiveFailures  Int @default(0)
  consecutiveSuccesses Int @default(0)

  changedAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model UptimeEvent {
  id              String         @id @default(cuid())
  siteId           String
  site             Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)

  fromState        UptimeState
  toState          UptimeState
  reasonStatus     SiteCheckStatus
  reasonHttpStatus Int?
  checkedAt        DateTime
  createdAt        DateTime       @default(now())

  @@index([siteId, createdAt])
  @@index([createdAt])
}

model SiteSnapshot {
  id                 String         @id @default(cuid())
  siteId             String
  site               Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Full HTML capture
  htmlBody           String
  htmlSize           Int

  // Response metadata
  statusCode         Int
  headers            Json

  // Diff tracking
  previousSnapshotId String?
  previousSnapshot   SiteSnapshot?  @relation("SnapshotDiff", fields: [previousSnapshotId], references: [id], onDelete: SetNull)
  nextSnapshots      SiteSnapshot[] @relation("SnapshotDiff")

  // Computed diff
  diffSummary        Json?
  changeLevel        ChangeLevel    @default(NONE)

  createdAt          DateTime       @default(now())

  @@index([siteId, createdAt])
  @@index([createdAt])
}
